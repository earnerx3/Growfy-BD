<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growfy - ফিড</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@600;700&display=swap" rel="stylesheet">

    <script src='//libtl.com/sdk.js' data-zone='9885140' data-sdk='show_9885140'></script>

    <style>
        :root {
            --primary-color: #1877f2;
            --verified-color: #1d9bf0;
            --monetized-color: #ff6b35;
            --background-color: #f0f2f5; 
            --card-bg-color: #ffffff;
            --text-color: #050505; 
            --subtle-text-color: #65676b;
            --white-color: #ffffff;
            --liked-color: #e74c3c;
            --shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            --border-color: #e9ecef;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popup-anim { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Noto Sans Bengali', sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            padding-top: 75px; 
            padding-bottom: 75px; 
        }
        
        .main-header, .bottom-nav { transition: transform 0.4s ease-in-out; }
        .main-header.hidden { transform: translateX(-50%) translateY(-120%); }
        .bottom-nav.hidden { transform: translateX(-50%) translateY(120%); }
        
        .main-header { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-radius: 28px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 1000; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; height: 55px; }
        .main-header .logo-text { font-family: 'Oswald', sans-serif; font-size: 24px; font-weight: 700; color: var(--primary-color); }
        .header-icons { display: flex; gap: 10px; }
        .header-icon a { font-size: 18px; color: var(--subtle-text-color); background-color: #e4e6eb; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: all 0.2s ease; }
        .header-icon a:hover { background-color: var(--primary-color); color: white; }
        
        .main-content { max-width: 500px; margin: 0 auto; padding: 0 10px; }
        .create-post-card { background: var(--card-bg-color); border-radius: 12px; padding: 12px 15px; margin-bottom: 15px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; transition: transform 0.2s ease; }
        .create-post-card:hover { transform: translateY(-2px); }
        .create-post-card .profile-pic-link { cursor: pointer; }
        .create-post-card img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .create-post-card .post-input-wrapper { flex-grow: 1; cursor: pointer; }
        .create-post-card .post-input { color: var(--subtle-text-color); font-size: 16px; pointer-events: none; }
        
        /* নতুন পোস্ট নোটিফিকেশন বাটনের জন্য CSS */
        .new-post-notifier {
            position: fixed;
            top: 70px; /* main-header এর নিচে */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        .new-post-notifier:hover {
            transform: translateX(-50%) scale(1.05);
        }

        .post-card { background: var(--card-bg-color); border-radius: 12px; margin-bottom: 15px; box-shadow: var(--shadow); animation: fadeIn 0.3s; transition: transform 0.2s ease; }
        .post-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .post-header { display: flex; align-items: center; padding: 12px 15px; gap: 10px; }
        .author-clickable { cursor: pointer; transition: opacity 0.2s ease; }
        .author-clickable:hover { opacity: 0.8; }
        .post-header .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .post-user-info { flex-grow: 1; }
        .user-name { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 4px; }
        .verified-badge { color: var(--verified-color); font-size: 14px; }
        .monetized-badge { color: var(--monetized-color); font-size: 14px; animation: pulse 2s infinite; }
        .post-user-info .timestamp { font-size: 12px; color: var(--subtle-text-color); }
        .post-header .post-action-wrapper { margin-left: auto; }
        .follow-btn, .following-btn { border: none; border-radius: 6px; padding: 5px 12px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .follow-btn { background-color: #e7f3ff; color: var(--primary-color); }
        .follow-btn:hover { background-color: var(--primary-color); color: white; }
        .following-btn { background-color: #e4e6eb; color: var(--text-color); }
        .following-btn:hover { background-color: #d0d2d7; }
        
        .earning-badge { background-color: #fff5e0; color: #ff9800; border-radius: 8px; padding: 4px 10px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .earning-badge.monetized { background-color: #ffe0d6; color: var(--monetized-color); }
        .earning-badge i.fa-coins { font-size: 11px; }

        .post-content { padding: 0 15px 12px 15px; }
        .post-content p { font-size: 15px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        .post-image { width: 100%; object-fit: cover; margin-top: 10px; border-radius: 8px; }
        .post-stats { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; font-size: 14px; color: var(--subtle-text-color); }
        .post-stats .likes-count { font-weight: 500; }
        .post-stats .comments-views { display: flex; gap: 15px; }
        .post-actions { display: flex; justify-content: space-around; padding: 5px 0; border-top: 1px solid var(--border-color); }
        .action-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 8px 0; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 14px; color: var(--subtle-text-color); transition: all 0.2s ease; }
        .action-btn:hover { background-color: #f0f2f5; border-radius: 8px; }
        .action-btn.liked { color: var(--liked-color); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: flex-end; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-panel { background: var(--card-bg-color); border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; position: relative; animation: popup-anim 0.3s ease; }
        .comment-panel { max-height: 85vh; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .modal-header .title { font-size: 18px; font-weight: 700; }
        .header-actions { display: flex; gap: 10px; }
        .header-actions .icon-btn { background: #f0f2f5; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 14px; cursor: pointer; transition: background-color 0.2s ease; }
        .header-actions .icon-btn:hover { background: #e4e6eb; }
        .comment-list { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 15px; }
        .comment-item img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .comment-body { background-color: #f0f2f5; padding: 8px 12px; border-radius: 15px; width: 100%; }
        .comment-body .name { font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 4px; }
        .comment-content-wrapper { flex-grow: 1; }
        .comment-text { margin-top: 2px; font-size: 14px; }
        .comment-meta { font-size: 11px; color: var(--subtle-text-color); margin-top: 4px; }
        
        .comment-input-area { padding: 10px 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; align-items: center; }
        .comment-input-area input { flex-grow: 1; border: none; background-color: #f0f2f5; border-radius: 20px; padding: 10px 15px; font-size: 15px; outline: none; }
        .comment-input-area button { background-color: var(--primary-color); border: none; color: var(--white-color); width: 40px; height: 40px; border-radius: 50%; font-size: 16px; cursor: pointer; transition: background-color 0.2s ease; }
        .comment-input-area button:hover { background-color: #166fe5; }
        .comment-input-area button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .profile-preview-panel { padding: 20px; }
        .profile-preview-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .profile-preview-header img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .profile-preview-header .name-details .name { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 4px; }
        .profile-preview-header .name-details .username { font-size: 14px; color: var(--subtle-text-color); }
        .profile-preview-bio { font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
        .profile-preview-actions { display: flex; gap: 10px; }
        .profile-preview-actions .btn { flex: 1; padding: 10px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s ease; }
        .btn-subscribe { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-subscribe:hover { background-color: #166fe5; }
        .btn-subscribe.following { background-color: #e4e6eb; color: var(--text-color); border-color: var(--border-color); }
        .btn-view-channel { background-color: transparent; color: var(--text-color); }
        .btn-view-channel:hover { background-color: #f0f2f5; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .loading-indicator { text-align: center; padding: 20px; color: var(--subtle-text-color); }
        .bottom-nav { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); display: flex; justify-content: space-around; align-items: center; height: 55px; border-radius: 28px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 1000; }
        .nav-item-wrapper { flex: 1; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #aaa; transition: color 0.2s ease; }
        .nav-item:hover { color: var(--primary-color); }
        .nav-item i { font-size: 20px; }
        .nav-item span { font-size: 10px; margin-top: 3px; } 
        .nav-item.active { color: var(--primary-color); }

        .priority-post { border-left: 3px solid var(--primary-color); }
        
        .post-card.loading { opacity: 0.7; pointer-events: none; }
    </style>
</head>
<body>
    <header class="main-header" id="mainHeader">
        <span class="logo-text">Growfy</span>
        <div class="header-icons">
            <div class="header-icon"><a href="search.html"><i class="fas fa-search"></i></a></div>
            <div class="header-icon"><a href="notifications.html"><i class="fas fa-bell"></i></a></div>
        </div>
    </header>

    <main class="main-content">
        <div id="newPostNotifier" class="new-post-notifier" style="display: none;">
            <span>নতুন পোস্ট দেখুন</span>
        </div>

        <div class="create-post-card">
            <a class="profile-pic-link" href="profile.html"><img src="https://api.dicebear.com/9.x/initials/svg?seed=?" id="createPostPic" alt="Profile"></a>
            <div class="post-input-wrapper" onclick="window.location.href='create_post.html'"><span class="post-input">কিছু লিখুন...</span></div>
        </div>
        <div class="feed-container" id="feedContainer"></div>
        <div id="loadingIndicator" class="loading-indicator" style="display: none;"><p>লোড হচ্ছে...</p></div>
    </main>
    
    <div class="bottom-nav" id="bottomNav">
        <div class="nav-item-wrapper"><a href="index.html" class="nav-item active"><i class="fas fa-home"></i><span>ফিড</span></a></div>
        <div class="nav-item-wrapper"><a href="tasks.html" class="nav-item"><i class="fas fa-tasks"></i><span>টাস্ক</span></a></div>
        <div class="nav-item-wrapper"><a href="share_market.html" class="nav-item"><i class="fas fa-chart-line"></i><span>মার্কেট</span></a></div>
        <div class="nav-item-wrapper"><a href="leaderboard.html" class="nav-item"><i class="fas fa-trophy"></i><span>লিডারবোর্ড</span></a></div>
        <div class="nav-item-wrapper"><a href="profile.html" class="nav-item"><i class="fas fa-user"></i><span>প্রোফাইল</span></a></div>
    </div>

    <div class="modal-overlay" id="commentModal">
        <div class="modal-panel comment-panel">
            <div class="modal-header">
                <span class="title">কমেন্টস</span>
                <div class="header-actions">
                    <button class="icon-btn"><i class="fas fa-cog"></i></button>
                    <button class="icon-btn close-modal"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="comment-list" id="commentList"></div>
            <div class="comment-input-area">
                <input type="text" id="commentInput" placeholder="আপনার মন্তব্য লিখুন..."><button id="postCommentBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="profilePreviewModal">
        <div class="modal-panel profile-preview-panel">
            <div class="profile-preview-header">
                <img id="previewAvatar" src="/placeholder.svg">
                <div class="name-details">
                    <div id="previewName" class="name"></div>
                    <div id="previewUsername" class="username"></div>
                </div>
            </div>
            <p id="previewBio" class="profile-preview-bio"></p>
            <div class="profile-preview-actions">
                <button class="btn btn-subscribe" id="previewFollowBtn">Follow</button>
                <button class="btn btn-view-channel" id="previewViewBtn">View Profile</button>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyD47fqKpliPqz64458u4Oxc2ymn6VEdPvw",
          authDomain: "growfy-cd6ac.firebaseapp.com",
          databaseURL: "https://growfy-cd6ac-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "growfy-cd6ac",
          storageBucket: "growfy-cd6ac.firebasestorage.app",
          messagingSenderId: "452195809736",
          appId: "1:452195809736:web:11204e0fd1e01e92a9a8fd",
          measurementId: "G-DFDJRCX4ED"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const feedContainer = document.getElementById('feedContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const commentModal = document.getElementById('commentModal');
        const profilePreviewModal = document.getElementById('profilePreviewModal');
        
        let lastVisiblePost = null, isLoading = false, currentUserData = null;
        let initialLoadComplete = false;
        let displayedPostIds = new Set();
        let postObserver;
        let currentPreviewUserId = null;

        // **নতুন পরিবর্তন**
        let newPostsQueue = []; // নতুন পোস্ট জমা রাখার জন্য
        const newPostNotifier = document.getElementById('newPostNotifier');

        let lastAdShown = 0;

        async function showAdAfterAction() {
            const now = Date.now();
            if (now - lastAdShown < 30000) return;

            if (typeof show_9885140 === 'function') {
                try {
                    await show_9885140();
                    lastAdShown = now;
                } catch (error) {
                    console.error("[v0] Ad failed to show:", error);
                }
            }
        }
        
        function getSeenPostsFromStorage() {
            const seen = localStorage.getItem('growfy_seen_posts');
            return seen ? new Set(JSON.parse(seen)) : new Set();
        }

        function updateSeenPostsInStorage(postId) {
            const seenPosts = getSeenPostsFromStorage();
            seenPosts.add(postId);
            const seenArray = Array.from(seenPosts).slice(-500);
            localStorage.setItem('growfy_seen_posts', JSON.stringify(seenArray));
        }

        function getLikedPostsFromStorage() {
            const liked = localStorage.getItem('growfy_liked_posts');
            return liked ? new Set(JSON.parse(liked)) : new Set();
        }

        function updateLocalStorageLikes(postId, isLiked) {
            const likedPosts = getLikedPostsFromStorage();
            if (isLiked) {
                likedPosts.add(postId);
            } else {
                likedPosts.delete(postId);
            }
            localStorage.setItem('growfy_liked_posts', JSON.stringify(Array.from(likedPosts)));
        }

        function formatNumber(num) {
            const number = Number(num) || 0;
            if (number >= 1000000) return (number / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (number >= 1000) return (number / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            return number;
        }

        function timeAgo(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'কিছুক্ষণ আগে';
            const now = new Date();
            const seconds = Math.floor((now - timestamp.toDate()) / 1000);
            if (seconds < 60) return "এইমাত্র";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} মিনিট আগে`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} ঘন্টা আগে`;
            const days = Math.floor(hours / 24);
            return `${days} দিন আগে`;
        }
        
        // **'renderPosts' ফাংশনে নতুন প্যারামিটার যোগ করা হয়েছে**
        function renderPosts(posts, prepend = false, isInitialLoad = false) {
            let postsHTML = '';
            const likedPosts = getLikedPostsFromStorage();
            const seenPosts = getSeenPostsFromStorage();

            posts.forEach(post => {
                if (!post || !post.authorName || !post.text || !post.createdAt) {
                    console.warn("[v0] Skipping a malformed post object:", post);
                    return; 
                }

                // **খালি ফিড সমস্যার সমাধান**
                // শুধুমাত্র ইনফিনিট স্ক্রল করার সময় দেখা পোস্ট স্কিপ করা হবে, প্রাথমিক লোডে নয়
                if (seenPosts.has(post.id) && !prepend && !isInitialLoad) {
                    console.log(`[v0] Skipping already seen post on scroll: ${post.id}`);
                    return;
                }
                
                if (displayedPostIds.has(post.id) && !prepend) return;
                displayedPostIds.add(post.id);
                
                const likes = post.likes || 0;
                const comments = post.comments || 0;
                const views = post.views || 0;
                const points = post.points || 0;

                const isOwnPost = auth.currentUser && auth.currentUser.uid === post.authorId;
                const isFollowedUser = currentUserData?.following?.includes(post.authorId);
                
                let verificationBadge = '';
                if (post.authorIsMonetized) {
                    verificationBadge = `<i class="fas fa-check-circle monetized-badge" title="Monetized Creator"></i>`;
                } else if (post.authorIsVerified) {
                    verificationBadge = `<i class="fas fa-check-circle verified-badge" title="Verified User"></i>`;
                }
                
                const authorAvatar = post.authorAvatar || `https://api.dicebear.com/9.x/initials/svg?seed=${post.authorName.charAt(0)}`;

                let postActionHTML = '';
                if (isOwnPost) {
                    const badgeClass = post.authorIsMonetized ? 'earning-badge monetized' : 'earning-badge';
                    const multiplier = post.authorIsMonetized ? ' (2x)' : '';
                    postActionHTML = `<a href="wallet.html" style="text-decoration: none;"><div class="${badgeClass}"><i class="fas fa-coins"></i> <span>${points} Points${multiplier}</span></div></a>`;
                } else {
                    const isFollowing = currentUserData?.following?.includes(post.authorId);
                    const btnClass = isFollowing ? 'following-btn' : 'follow-btn';
                    const btnText = isFollowing ? 'Following' : 'Follow';
                    postActionHTML = `<button class="${btnClass}" data-author-id="${post.authorId}">${btnText}</button>`;
                }

                const isLiked = likedPosts.has(post.id);
                const likeBtnClass = isLiked ? 'action-btn like liked' : 'action-btn like';
                const likeIconClass = isLiked ? 'fas fa-heart' : 'far fa-heart';
                
                const priorityClass = isFollowedUser ? 'priority-post' : '';

                postsHTML += `
                    <div class="post-card ${priorityClass}" data-id="${post.id}" data-author-id="${post.authorId}">
                        <div class="post-header">
                            <div class="author-clickable" style="display: contents;">
                                <img class="avatar" src="${authorAvatar}" alt="Avatar">
                                <div class="post-user-info">
                                    <p class="user-name">${post.authorName} ${verificationBadge}</p>
                                    <span class="timestamp">${timeAgo(post.createdAt)}</span>
                                </div>
                            </div>
                            <div class="post-action-wrapper">${postActionHTML}</div>
                        </div>
                        <div class="post-content">
                            <p>${post.text.replace(/\n/g, '<br>')}</p>
                            ${post.imageUrl ? `<img class="post-image" src="${post.imageUrl}" alt="Post Image">` : ''}
                        </div>
                        <div class="post-stats">
                            <div class="likes-count">${formatNumber(likes)} Likes</div>
                            <div class="comments-views">
                                <span class="comment-count">${formatNumber(comments)} Comments</span>
                                <span class="view-count"><i class="fas fa-eye"></i> ${formatNumber(views)}</span>
                            </div>
                        </div>
                        <div class="post-actions">
                            <button class="${likeBtnClass}"><i class="${likeIconClass}"></i> Like</button>
                            <button class="action-btn comment"><i class="far fa-comment-alt"></i> Comment</button>
                            <button class="action-btn share"><i class="fas fa-share"></i> Share</button>
                        </div>
                    </div>`;
            });
            if (prepend) {
                feedContainer.insertAdjacentHTML('afterbegin', postsHTML);
            } else {
                feedContainer.insertAdjacentHTML('beforeend', postsHTML);
            }
            observePostsForViewCount();
        }
        
        // **'fetchPosts' ফাংশনে পরিবর্তন আনা হয়েছে**
        async function fetchPosts(firstPage = false) {
            if (isLoading) return;
            isLoading = true;
            loadingIndicator.style.display = 'block';

            try {
                let allPosts = [];
                
                if (firstPage && currentUserData?.following && currentUserData.following.length > 0) {
                    const followedQuery = db.collection('posts')
                        .where('authorId', 'in', currentUserData.following.slice(0, 10))
                        .orderBy('createdAt', 'desc')
                        .limit(3);
                    
                    const followedSnapshot = await followedQuery.get();
                    const followedPosts = followedSnapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(),
                        isFollowedUser: true 
                    }));
                    allPosts.push(...followedPosts);
                }

                let generalQuery = db.collection('posts').orderBy('createdAt', 'desc').limit(10);
                if (lastVisiblePost && !firstPage) {
                    generalQuery = generalQuery.startAfter(lastVisiblePost);
                }

                const generalSnapshot = await generalQuery.get();
                const generalPosts = generalSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));

                allPosts.push(...generalPosts);
                
                const uniquePosts = allPosts.filter((post, index, self) => 
                    index === self.findIndex(p => p.id === post.id)
                );
                
                uniquePosts.sort((a, b) => {
                    if (a.isFollowedUser && !b.isFollowedUser) return -1;
                    if (!a.isFollowedUser && b.isFollowedUser) return 1;
                    return b.createdAt?.toDate() - a.createdAt?.toDate();
                });

                if (firstPage && uniquePosts.length === 0 && feedContainer.children.length === 0) {
                    feedContainer.innerHTML = '<p style="text-align: center; color: var(--subtle-text-color); padding: 20px;">এখনো কোনো পোস্ট নেই।</p>';
                }

                if (uniquePosts.length > 0) {
                    lastVisiblePost = generalSnapshot.docs[generalSnapshot.docs.length - 1];
                    // **খালি ফিড সমস্যার সমাধান:** `firstPage` প্যারামিটার পাঠানো হচ্ছে
                    renderPosts(uniquePosts, false, firstPage);
                }
                
                if (generalPosts.length < 10) {
                    loadingIndicator.textContent = 'আর কোনো পোস্ট নেই।';
                } else {
                    loadingIndicator.style.display = 'none';
                }

            } catch (error) {
                console.error("[v0] Error fetching posts:", error);
                loadingIndicator.textContent = 'পোস্ট লোড করতে সমস্যা হয়েছে।';
            } finally {
                isLoading = false;
                if (firstPage) {
                    initialLoadComplete = true;
                }
            }
        }
        
        async function openCommentModal(postId) {
            const commentList = document.getElementById('commentList');
            commentList.innerHTML = '<p>লোড হচ্ছে...</p>';
            commentModal.classList.add('active');
            document.getElementById('postCommentBtn').dataset.postId = postId;

            db.collection('posts').doc(postId).collection('comments').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                commentList.innerHTML = '';
                if(snapshot.empty) commentList.innerHTML = '<p style="text-align:center; color: var(--subtle-text-color);">এখনো কোনো কমেন্ট নেই।</p>';
                
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    let verificationBadge = '';
                    if (comment.authorIsMonetized) {
                        verificationBadge = `<i class="fas fa-check-circle monetized-badge"></i>`;
                    } else if (comment.authorIsVerified) {
                        verificationBadge = `<i class="fas fa-check-circle verified-badge"></i>`;
                    }
                    
                    const authorAvatar = comment.authorAvatar || `https://api.dicebear.com/9.x/initials/svg?seed=${comment.authorName ? comment.authorName.charAt(0) : '?'}`;
                    
                    commentList.innerHTML += `
                        <div class="comment-item">
                            <img src="${authorAvatar}" alt="Avatar">
                            <div class="comment-body">
                                <div class="comment-content-wrapper">
                                    <span class="name">${comment.authorName || 'Unknown'} ${verificationBadge}</span>
                                    <p class="comment-text">${comment.text || ''}</p>
                                    <div class="comment-meta">${timeAgo(comment.createdAt)}</div>
                                </div>
                            </div>
                        </div>`;
                });
            });
        }
        
        async function postComment() {
            const postId = document.getElementById('postCommentBtn').dataset.postId;
            const commentInput = document.getElementById('commentInput');
            const text = commentInput.value.trim();

            if (!text || !currentUserData || !postId) {
                if (!currentUserData) alert("আপনার তথ্য এখনো লোড হচ্ছে। অনুগ্রহ করে কিছুক্ষণ পর আবার চেষ্টা করুন।");
                return;
            }
            
            commentInput.disabled = true;
            document.getElementById('postCommentBtn').disabled = true;

            try {
                const commentsRef = db.collection('posts').doc(postId).collection('comments');
                const userPreviousComments = await commentsRef.where('authorId', '==', auth.currentUser.uid).limit(1).get();
                const isFirstComment = userPreviousComments.empty;

                const batch = db.batch();
                const newCommentRef = commentsRef.doc();
                const authorAvatar = currentUserData.profileImageUrl || `https://api.dicebear.com/9.x/initials/svg?seed=${currentUserData.fullName.charAt(0)}`;
                
                batch.set(newCommentRef, {
                    text,
                    authorId: auth.currentUser.uid,
                    authorName: currentUserData.fullName,
                    authorAvatar,
                    authorIsVerified: currentUserData.isVerified || false,
                    authorIsMonetized: currentUserData.isMonetized || false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const postRef = db.collection('posts').doc(postId);
                batch.update(postRef, { comments: firebase.firestore.FieldValue.increment(1) });
                
                if (isFirstComment) {
                    const pointsToAdd = currentUserData.isMonetized ? 4 : 2;
                    const userPointsToAdd = currentUserData.isMonetized ? 2 : 1;
                    
                    batch.update(postRef, { points: firebase.firestore.FieldValue.increment(pointsToAdd) });
                    const commenterRef = db.collection('users').doc(auth.currentUser.uid);
                    batch.update(commenterRef, { totalPoints: firebase.firestore.FieldValue.increment(userPointsToAdd) });
                }

                await batch.commit();
                commentInput.value = '';
                showAdAfterAction();
            } catch(error) {
                console.error("[v0] Error posting comment:", error);
                alert("কমেন্ট পোস্ট করা সম্ভব হয়নি। অনুগ্রহ করে আবার চেষ্টা করুন।");
            } finally {
                commentInput.disabled = false;
                document.getElementById('postCommentBtn').disabled = false;
            }
        }

        async function handleLike(postId, authorId, likeBtn) {
            if (!currentUserData) {
                alert("আপনার তথ্য এখনো লোড হচ্ছে। অনুগ্রহ করে কিছুক্ষণ পর আবার চেষ্টা করুন।");
                return;
            }

            const isLiked = !likeBtn.classList.contains('liked');
            likeBtn.disabled = true;

            likeBtn.classList.toggle('liked');
            likeBtn.querySelector('i').classList.toggle('far');
            likeBtn.querySelector('i').classList.toggle('fas');
            updateLocalStorageLikes(postId, isLiked);

            const postRef = db.collection('posts').doc(postId);
            try {
                 if (isLiked) {
                    showAdAfterAction();
                    const likerRef = db.collection('users').doc(auth.currentUser.uid);
                    const likePointsRef = postRef.collection('likePoints').doc(auth.currentUser.uid);
                    
                    await db.runTransaction(async (transaction) => {
                        const likePointsDoc = await transaction.get(likePointsRef);
                        if (!likePointsDoc.exists) {
                            const pointsToAdd = currentUserData.isMonetized ? 2 : 1;
                            const userPointsToAdd = currentUserData.isMonetized ? 1 : 0.5;
                            
                            transaction.update(postRef, {
                                likes: firebase.firestore.FieldValue.increment(1),
                                points: firebase.firestore.FieldValue.increment(pointsToAdd)
                            });
                            transaction.update(likerRef, { totalPoints: firebase.firestore.FieldValue.increment(userPointsToAdd) });
                            transaction.set(likePointsRef, { awardedAt: firebase.firestore.FieldValue.serverTimestamp() });
                        } else {
                            transaction.update(postRef, { likes: firebase.firestore.FieldValue.increment(1) });
                        }
                    });
                } else {
                    await postRef.update({ likes: firebase.firestore.FieldValue.increment(-1) });
                }
            } catch (error) {
                console.error("[v0] Error updating like:", error);
                alert("লাইক করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।");
                
                likeBtn.classList.toggle('liked');
                likeBtn.querySelector('i').classList.toggle('far');
                likeBtn.querySelector('i').classList.toggle('fas');
                updateLocalStorageLikes(postId, !isLiked);
            } finally {
                likeBtn.disabled = false;
            }
        }

        async function handleFollow(authorId, followBtn) {
            if (!auth.currentUser) return;

            const wasFollowing = followBtn.classList.contains('following-btn') || followBtn.classList.contains('following');
            const originalText = followBtn.textContent;
            followBtn.disabled = true; 
            
            if (wasFollowing) {
                followBtn.classList.remove('following-btn', 'following');
                followBtn.classList.add('follow-btn');
                followBtn.textContent = 'Follow';
            } else {
                followBtn.classList.remove('follow-btn');
                followBtn.classList.add('following-btn', 'following');
                followBtn.textContent = 'Following';
            }

            try {
                const currentUserRef = db.collection('users').doc(auth.currentUser.uid);
                const followedUserRef = db.collection('users').doc(authorId);
                const batch = db.batch();

                if (wasFollowing) {
                    batch.update(currentUserRef, { following: firebase.firestore.FieldValue.arrayRemove(authorId) });
                    batch.update(followedUserRef, { followers: firebase.firestore.FieldValue.arrayRemove(auth.currentUser.uid) });
                    if (currentUserData.following) currentUserData.following = currentUserData.following.filter(id => id !== authorId);
                } else {
                    showAdAfterAction();
                    batch.update(currentUserRef, { following: firebase.firestore.FieldValue.arrayUnion(authorId) });
                    batch.update(followedUserRef, { followers: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid) });
                    if (!currentUserData.following) currentUserData.following = [];
                    currentUserData.following.push(authorId);
                }
                await batch.commit();
            } catch (error) {
                console.error("[v0] Error updating follow status:", error);
                alert("অনুসরণ করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।");

                if (wasFollowing) {
                    followBtn.classList.remove('follow-btn');
                    followBtn.classList.add('following-btn', 'following');
                } else {
                    followBtn.classList.remove('following-btn', 'following');
                    followBtn.classList.add('follow-btn');
                }
                followBtn.textContent = originalText;
            } finally {
                followBtn.disabled = false; 
            }
        }

        function setupPostObserver() {
            if (postObserver) postObserver.disconnect();
            postObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const postId = entry.target.dataset.id;
                        db.collection('posts').doc(postId).update({ views: firebase.firestore.FieldValue.increment(1) }).catch(err => {});
                        updateSeenPostsInStorage(postId);
                        postObserver.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.5 });
        }

        function observePostsForViewCount() {
            document.querySelectorAll('.post-card:not([data-observed])').forEach(post => {
                postObserver.observe(post);
                post.dataset.observed = true;
            });
        }
        
        async function showProfilePreview(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) return;
                
                const userData = userDoc.data();
                currentPreviewUserId = userId;
                
                document.getElementById('previewAvatar').src = userData.profileImageUrl || `https://api.dicebear.com/9.x/initials/svg?seed=${userData.fullName ? userData.fullName.charAt(0) : '?'}`;
                
                const nameElement = document.getElementById('previewName');
                let nameHTML = userData.fullName || 'Unknown';
                if (userData.isMonetized) {
                    nameHTML += ' <i class="fas fa-check-circle monetized-badge"></i>';
                } else if (userData.isVerified) {
                    nameHTML += ' <i class="fas fa-check-circle verified-badge"></i>';
                }
                nameElement.innerHTML = nameHTML;
                
                document.getElementById('previewUsername').textContent = `@${userData.email ? userData.email.split('@')[0] : 'user'}`;
                document.getElementById('previewBio').textContent = userData.bio || "ব্যবহারকারী কোনো বায়ো যোগ করেননি।";
                
                const followBtn = document.getElementById('previewFollowBtn');
                const isFollowing = currentUserData?.following?.includes(userId);
                if (isFollowing) {
                    followBtn.textContent = 'Following';
                    followBtn.classList.add('following');
                } else {
                    followBtn.textContent = 'Follow';
                    followBtn.classList.remove('following');
                }
                
                profilePreviewModal.classList.add('active');
            } catch (error) {
                console.error("[v0] Error showing profile preview:", error);
            }
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                setupPostObserver();
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const firstLoad = !currentUserData;
                        currentUserData = doc.data();
                        const avatar = currentUserData.profileImageUrl || `https://api.dicebear.com/9.x/initials/svg?seed=${currentUserData.fullName ? currentUserData.fullName.charAt(0) : '?'}`;
                        document.getElementById('createPostPic').src = avatar;

                        if(firstLoad) {
                            fetchPosts(true);
                        }
                    }
                }, err => console.error("[v0] Error fetching user data:", err));
                
                // **'onSnapshot' লিসেনার পরিবর্তন করা হয়েছে**
                db.collection('posts').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        const postData = { id: change.doc.id, ...change.doc.data() };
                        const existingPost = document.querySelector(`.post-card[data-id="${postData.id}"]`);
                        
                        if (change.type === 'added' && initialLoadComplete && !existingPost && !displayedPostIds.has(postData.id)) {
                             if(change.doc.metadata.hasPendingWrites === false) {
                                 postData.isFollowedUser = currentUserData?.following?.includes(postData.authorId);
                                 
                                 // **নতুন পোস্টের সমাধান:** পোস্টটি সরাসরি রেন্ডার না করে Queue-তে যোগ করা
                                 newPostsQueue.unshift(postData); // unshift ব্যবহার করলে নতুনটা আগে থাকে
                                 
                                 // নোটিফিকেশন বাটন দেখানো
                                 newPostNotifier.style.display = 'block';
                                 newPostNotifier.querySelector('span').textContent = `${newPostsQueue.length} টি নতুন পোস্ট দেখুন`;
                             }
                        }
                        if (change.type === 'modified' && existingPost) {
                            existingPost.querySelector('.likes-count').textContent = `${formatNumber(postData.likes || 0)} Likes`;
                            existingPost.querySelector('.comment-count').textContent = `${formatNumber(postData.comments || 0)} Comments`;
                            existingPost.querySelector('.view-count').innerHTML = `<i class="fas fa-eye"></i> ${formatNumber(postData.views || 0)}`;
                            if (existingPost.querySelector('.earning-badge span')) {
                                const multiplier = postData.authorIsMonetized ? ' (2x)' : '';
                                existingPost.querySelector('.earning-badge span').textContent = `${postData.points || 0} Points${multiplier}`;
                            }
                        }
                        if (change.type === 'removed' && existingPost) existingPost.remove();
                    });
                }, err => console.error("[v0] Error with real-time listener:", err));
            } else {
                window.location.replace('auth.html');
            }
        });
        
        window.addEventListener('scroll', () => { 
            if (!isLoading && (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                fetchPosts(); 
            }
        });

        // **নতুন পোস্ট নোটিফিকেশন বাটনের জন্য নতুন ক্লিক ইভেন্ট**
        newPostNotifier.addEventListener('click', () => {
            renderPosts(newPostsQueue, true); 
            newPostsQueue = [];
            newPostNotifier.style.display = 'none';
            
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        document.body.addEventListener('click', function(e) {
            const createPostCard = e.target.closest('.create-post-card');
            if (createPostCard) {
                if (e.target.closest('.profile-pic-link')) { 
                    e.preventDefault(); 
                    window.location.href = 'profile.html'; 
                }
                else if (e.target.closest('.post-input-wrapper')) { 
                    window.location.href = 'create_post.html'; 
                }
                return;
            }

            const postCard = e.target.closest('.post-card');
            if(postCard) {
                const postId = postCard.dataset.id;
                const authorId = postCard.dataset.authorId;
                
                if (e.target.closest('.action-btn.comment')) openCommentModal(postId);
                else if (e.target.closest('.action-btn.like')) handleLike(postId, authorId, e.target.closest('.action-btn.like'));
                else if (e.target.closest('.author-clickable')) showProfilePreview(authorId);
                else if (e.target.closest('.follow-btn') || e.target.closest('.following-btn')) handleFollow(authorId, e.target);
                else if (e.target.closest('.action-btn.share')) {
                    const postText = postCard.querySelector('.post-content p')?.innerText || "Growfy থেকে একটি পোস্ট";
                    if(navigator.share) navigator.share({ title: 'Growfy Post', text: postText, url: window.location.href }).catch(err => console.error("[v0] Share failed:", err));
                    else navigator.clipboard.writeText(window.location.href).then(() => alert('পোস্ট লিংক কপি করা হয়েছে!')).catch(() => alert('দুঃখিত, কপি করা সম্ভব হয়নি।'));
                }
            }
            
            if (e.target.closest('#previewFollowBtn')) {
                e.preventDefault();
                if (currentPreviewUserId) handleFollow(currentPreviewUserId, e.target.closest('#previewFollowBtn'));
            }
            
            if (e.target.closest('#previewViewBtn')) {
                e.preventDefault();
                if (currentPreviewUserId) window.location.href = `profile.html?userId=${currentPreviewUserId}`;
            }
            
            if (e.target.closest('.close-modal') || e.target.classList.contains('modal-overlay')) {
                e.target.closest('.modal-overlay').classList.remove('active');
                currentPreviewUserId = null;
            }

            if (e.target.closest('#postCommentBtn')) postComment();
        });

        let lastScrollTop = 0;
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const mainHeader = document.getElementById('mainHeader');
                const bottomNav = document.getElementById('bottomNav');
                
                if (scrollTop > lastScrollTop && scrollTop > 100) { 
                    mainHeader.classList.add('hidden');
                    bottomNav.classList.add('hidden');
                } else if (scrollTop < lastScrollTop) { 
                    mainHeader.classList.remove('hidden');
                    bottomNav.classList.remove('hidden');
                }
                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            }, 10);
        });
    </script>
</body>
</html>
