<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Growfy - নতুন বিজ্ঞাপন</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1877f2;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --background-color: #f0f2f5; 
            --card-bg-color: #ffffff;
            --text-color: #050505; 
            --subtle-text-color: #65676b;
            --white-color: #ffffff;
            --shadow: 0 4px_12px rgba(0, 0, 0, 0.06);
            --border-color: #e9ecef;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Noto Sans Bengali', sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            padding-top: 70px; 
            padding-bottom: 20px; 
        }
        
        /* --- Premium Header --- */
        .main-header { 
            position: fixed; z-index: 1000; top: 0; left: 0; right: 0;
            background: var(--card-bg-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }
        .header-title { font-size: 18px; font-weight: 700; }
        .header-icon a { 
            font-size: 20px; color: var(--text-color); 
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center; text-decoration: none; 
        }
        
        .main-content { max-width: 500px; margin: 0 auto; padding: 15px; animation: fadeIn 0.4s; }

        .ad-type-toggle { display: flex; background-color: var(--border-color); border-radius: 10px; padding: 4px; margin-bottom: 20px; }
        .ad-type-toggle button { flex: 1; padding: 9px; border: none; background-color: transparent; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .ad-type-toggle .buy-btn { color: var(--success-color); }
        .ad-type-toggle .sell-btn { color: var(--danger-color); }
        .ad-type-toggle button.active { background-color: var(--card-bg-color); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        
        .form-section { background: var(--card-bg-color); padding: 12px 15px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .section-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; }
        
        .form-group { margin-bottom: 12px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 13px; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 11px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: #fafafa; }
        .form-group input:focus { background: var(--white-color); border-color: var(--primary-color); outline: none; }
        .balance-info { font-size: 12px; color: var(--subtle-text-color); margin-top: 6px; }
        
        .input-with-addon { display: flex; }
        .input-with-addon input { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .input-with-addon .addon { padding: 0 15px; background-color: #f0f2f5; border: 1px solid var(--border-color); border-left: none; border-radius: 0 8px 8px 0; display: flex; align-items: center; font-weight: 600; font-size: 14px; }
        
        /* --- Premium Payment Method Selector with Number Input --- */
        .payment-options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .payment-option-card { border: 2px solid var(--border-color); border-radius: 8px; transition: all 0.2s ease; }
        .payment-option-card.selected { border-color: var(--primary-color); background-color: #f7faff; }
        .payment-header { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; }
        .payment-header input[type="checkbox"] { display: none; }
        .payment-logo { height: 24px; }
        .payment-name { font-weight: 600; }
        .payment-number-input { padding: 0 10px 10px 10px; display: none; }
        
        .summary-box { background-color: rgba(243, 156, 18, 0.1); border: 1px solid rgba(243, 156, 18, 0.3); border-radius: 12px; padding: 12px; margin-top: 5px; display: none; }
        .summary-box.visible { display: block; }
        .security-note { font-size: 12px; color: #8a6d3b; line-height: 1.5; }
        
        .post-ad-button { width: 100%; padding: 13px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 20px; transition: all 0.3s; }
        .post-ad-button.buy { background: linear-gradient(45deg, var(--success-color), #2ecc71); color: var(--white-color); }
        .post-ad-button.sell { background: linear-gradient(45deg, var(--danger-color), #e67e22); color: var(--white-color); }
        .post-ad-button:disabled { background: #e4e6eb; cursor: not-allowed; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-icon"><a href="p2p_marketplace.html"><i class="fas fa-arrow-left"></i></a></div>
        <h2 class="header-title">নতুন বিজ্ঞাপন</h2>
        <div class="header-icon"><a href="my_ads_history.html"><i class="fas fa-history"></i></a></div>
    </header>

    <main class="main-content">
        <div class="ad-type-toggle">
            <button id="buyBtn" class="buy-btn"><i class="fas fa-shopping-cart"></i> কিনুন</button>
            <button id="sellBtn" class="sell-btn active"><i class="fas fa-tag"></i> বিক্রয় করুন</button>
        </div>

        <form id="postAdForm">
            <div class="form-section">
                <h3 class="section-title">মূল্য ও পরিমাণ</h3>
                <div class="form-group">
                    <label for="amount">পরিমাণ (পয়েন্ট)</label>
                    <input type="number" id="amount" placeholder="e.g., 1000" required>
                    <p class="balance-info" id="userBalanceInfo" style="display:none;"></p>
                </div>
                <div class="form-group">
                    <label for="price">মূল্য (প্রতি পয়েন্ট)</label>
                    <div class="input-with-addon">
                        <input type="number" step="0.01" id="price" placeholder="e.g., 1.15" required>
                        <span class="addon">BDT</span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">ট্রেড লিমিট (BDT)</h3>
                <div class="form-group">
                    <label for="minLimit">সর্বনিম্ন অর্ডার</label>
                    <input type="number" id="minLimit" placeholder="e.g., 500" required>
                </div>
                <div class="form-group">
                    <label for="maxLimit">সর্বোচ্চ অর্ডার</label>
                    <input type="number" id="maxLimit" placeholder="e.g., 10000" required>
                </div>
            </div>

            <div class="form-section">
                 <h3 class="section-title">পেমেন্ট পদ্ধতি ও সময়</h3>
                 <div class="form-group">
                    <label>পেমেন্ট পদ্ধতি যুক্ত করুন</label>
                    <div class="payment-options-grid">
                        <!-- Bkash Option -->
                        <div class="payment-option-card" id="bkash_card">
                            <label class="payment-header">
                                <input type="checkbox" name="paymentMethod" value="bkash">
                                <img src="bkash.png" alt="bKash" class="payment-logo">
                                <span class="payment-name">বিকাশ</span>
                            </label>
                            <div class="payment-number-input" id="bkash_input_wrapper">
                                <input type="text" id="bkash_number" placeholder="আপনার বিকাশ নম্বর দিন" class="form-control">
                            </div>
                        </div>
                        <!-- Nagad Option -->
                         <div class="payment-option-card" id="nagad_card">
                            <label class="payment-header">
                                <input type="checkbox" name="paymentMethod" value="nagad">
                                <img src="nagad.png" alt="Nagad" class="payment-logo">
                                <span class="payment-name">নগদ</span>
                            </label>
                            <div class="payment-number-input" id="nagad_input_wrapper">
                                <input type="text" id="nagad_number" placeholder="আপনার নগদ নম্বর দিন" class="form-control">
                            </div>
                        </div>
                    </div>
                 </div>
                 <div class="form-group">
                    <label for="paymentTime">পেমেন্টের সময়সীমা</label>
                    <select id="paymentTime" required>
                        <option value="15">১৫ মিনিট</option>
                        <option value="30">৩০ মিনিট</option>
                        <option value="45">৪৫ মিনিট</option>
                    </select>
                </div>
                <div class="form-section summary-box" id="summaryBox">
                    <p class="security-note">
                        আপনার <strong id="lockAmount">0</strong> পয়েন্ট বিজ্ঞাপন চলাকালীন সময়ের জন্য সুরক্ষিতভাবে লক করা হবে।
                    </p>
                </div>
            </div>

            <button type="submit" id="submitBtn" class="post-ad-button sell">বিজ্ঞাপন পোস্ট করুন</button>
        </form>
    </main>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD47fqKpliPqz64458u4Oxc2ymn6VEdPvw",
            authDomain: "growfy-cd6ac.firebaseapp.com",
            projectId: "growfy-cd6ac",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const buyBtn = document.getElementById('buyBtn');
        const sellBtn = document.getElementById('sellBtn');
        const summaryBox = document.getElementById('summaryBox');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('postAdForm');
        const amountInput = document.getElementById('amount');
        const userBalanceInfo = document.getElementById('userBalanceInfo');
        
        let currentAdtype = 'sell';
        let currentUserData = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        currentUserData = { id: doc.id, ...doc.data() };
                        userBalanceInfo.textContent = `আপনার ব্যালেন্স: ${(currentUserData.totalPoints || 0).toLocaleString('bn-BD')} পয়েন্ট`;
                    }
                });
            } else { window.location.replace('auth.html'); }
        });

        function setAdType(type) {
            currentAdtype = type;
            if (type === 'buy') {
                buyBtn.classList.add('active'); sellBtn.classList.remove('active');
                summaryBox.classList.remove('visible');
                userBalanceInfo.style.display = 'none';
                submitBtn.className = 'post-ad-button buy';
                submitBtn.textContent = 'ক্রয় বিজ্ঞাপন পোস্ট করুন';
            } else { // sell
                sellBtn.classList.add('active'); buyBtn.classList.remove('active');
                summaryBox.classList.add('visible');
                userBalanceInfo.style.display = 'block';
                submitBtn.className = 'post-ad-button sell';
                submitBtn.textContent = 'বিক্রয় বিজ্ঞাপন পোস্ট করুন';
            }
        }
        
        amountInput.addEventListener('input', () => {
             document.getElementById('lockAmount').textContent = (parseFloat(amountInput.value) || 0).toLocaleString('bn-BD');
        });
        
        // --- Dynamic Payment Input Logic ---
        document.querySelectorAll('input[name="paymentMethod"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const card = this.closest('.payment-option-card');
                const inputWrapper = card.querySelector('.payment-number-input');
                if (this.checked) {
                    card.classList.add('selected');
                    inputWrapper.style.display = 'block';
                } else {
                    card.classList.remove('selected');
                    inputWrapper.style.display = 'none';
                }
            });
        });
        
        // --- Form Submission ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserData) { alert("ব্যবহারকারীর তথ্য লোড হচ্ছে..."); return; }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'প্রসেসিং...';

            const amount = parseFloat(amountInput.value);
            const paymentDetails = {};
            const selectedMethods = [];
            
            document.querySelectorAll('input[name="paymentMethod"]:checked').forEach(cb => {
                const method = cb.value;
                const numberInput = document.getElementById(`${method}_number`);
                if (!numberInput.value) {
                    throw new Error(`${method} নম্বরটি দিন।`);
                }
                selectedMethods.push(method);
                paymentDetails[method] = numberInput.value;
            });

            if (selectedMethods.length === 0) {
                 alert('অনুগ্রহ করে অন্তত একটি পেমেন্ট পদ্ধতি নির্বাচন করুন।');
                 submitBtn.disabled = false; setAdType(currentAdtype); return;
            }

            const adData = {
                sellerId: currentUserData.id, sellerName: currentUserData.fullName,
                sellerAvatar: currentUserData.profileImageUrl || '',
                adType: currentAdtype, availablePoints: amount,
                pricePerPoint: parseFloat(document.getElementById('price').value),
                minLimit: parseFloat(document.getElementById('minLimit').value),
                maxLimit: parseFloat(document.getElementById('maxLimit').value),
                paymentMethods: selectedMethods, paymentDetails: paymentDetails,
                paymentTimeLimit: parseInt(document.getElementById('paymentTime').value, 10),
                status: 'active', createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (currentAdtype === 'sell') {
                if ((currentUserData.totalPoints || 0) < amount) {
                    alert('আপনার একাউন্টে পর্যাপ্ত পয়েন্ট নেই!');
                    submitBtn.disabled = false; setAdType('sell'); return;
                }
                const userRef = db.collection('users').doc(currentUserData.id);
                const newAdRef = db.collection('p2p_ads').doc();
                try {
                    await db.runTransaction(async (transaction) => {
                        transaction.update(userRef, {
                            totalPoints: firebase.firestore.FieldValue.increment(-amount),
                            lockedPoints: firebase.firestore.FieldValue.increment(amount)
                        });
                        transaction.set(newAdRef, adData);
                    });
                    alert('আপনার বিক্রয় বিজ্ঞাপন সফলভাবে পোস্ট হয়েছে!');
                    window.location.href = 'p2p_marketplace.html';
                } catch (error) {
                    alert('একটি সমস্যা হয়েছে: ' + error.message);
                    submitBtn.disabled = false; setAdType('sell');
                }
            } else { // Buy Ad Logic
                try {
                    await db.collection('p2p_ads').add(adData);
                    alert('আপনার ক্রয় বিজ্ঞাপন সফলভাবে পোস্ট হয়েছে!');
                    window.location.href = 'p2p_marketplace.html';
                } catch (error) {
                    alert('একটি সমস্যা হয়েছে: ' + error.message);
                    submitBtn.disabled = false; setAdType('buy');
                }
            }
        });
        
        buyBtn.addEventListener('click', () => setAdType('buy'));
        sellBtn.addEventListener('click', () => setAdType('sell'));
        setAdType('sell'); // Initial setup
    </script>
</body>
</html>